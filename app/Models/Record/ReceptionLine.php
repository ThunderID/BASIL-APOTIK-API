<?php

namespace App\Models\Record;

use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Validation\Rule;
use DB;

class ReceptionLine extends Model
{
	use SoftDeletes;
    // --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// TRAITS
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// VARIABLES
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	protected $table = 'reception_lines';

	protected $fillable = [
		'reception_id',
		'room_type_id',
		'room_id',
		'ci_at',
		'co_at',
		'price',
		'discount',
	];

	public $timestamps = true;

	protected $hidden = [
	];

	protected $casts = [
	];

	protected $dates = [
		'deleted_at',
		'ci_at',
		'co_at',
	];

	protected $touches = [
	];

	protected $observables = [
	];

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// CONFIGURATIONS
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// BOOT
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// CONSTRUCT
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// RELATIONSHIP
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	public function reception() {
		return $this->belongsTo(Reception::class, 'reception_id');
	}

	public function room() {
		return $this->belongsTo(\App\Room::class, 'room_id');
	}

	public function room_type() {
		return $this->belongsTo(\App\Models\Pricing\RoomType::class, 'room_type_id');
	}

	public function user_stays() {
		return $this->hasMany(UserStay::class);
	}

	public function voucher() {
		return $this->hasOne(Voucher::class, 'reception_line_id')->active($date);
	}

	public function vouchers() {
		return $this->hasMany(Voucher::class, 'reception_line_id');
	}

	public function ga_entries() {
		return $this->hasMany(GAEntry::class, 'reception_id', 'reception_id')->where('room_id', $this->room_id);
	}

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// BOOT
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// STATIC FUNCTION
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// FUNCTION
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	public function getRules()
	{
		$rules['reception_id']		= ['required', 'integer', 'exists:' . app()->make(Reception::class)->getTable() . ',id'];
		$rules['room_type_id']		= ['required', 'integer', 'exists:' . app()->make(\App\Models\Pricing\RoomType::class)->getTable() . ',id'];
		$rules['room_id']			= ['nullable', 'integer', 'exists:' . app()->make(\App\Room::class)->getTable() . ',id'];
		$rules['ci_at']             = ['nullable', 'date', 'after_or_equal:created_at'];
		$rules['co_at']             = ['nullable', 'date', 'after:ci_at'];
		$rules['price']             = ['nullable', 'numeric'];
		$rules['discount']          = ['nullable', 'numeric'];

		return $rules;
	}

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// ACCESSOR
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	public function getGABalanceAttribute() {
		return $this->ga_entries->where('invoice_id', null)->sum('amount');
	}

	public function getNetAttribute() {
		return $this->price - $this->discount;
	}

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// MUTATOR
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// QUERY
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
}
