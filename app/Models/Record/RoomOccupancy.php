<?php

namespace App\Models\Record;

use Illuminate\Database\Eloquent\Model;
use DB;

class RoomOccupancy extends Model
{
    // --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// TRAITS
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// VARIABLES
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	protected $fillable = [
		'org_id',
		'room_type_id',
		'at',
		'qty_reserved',
	];

	public $timestamps = true;

	protected $hidden = [
	];

	protected $casts = [
	];

	protected $dates = [
		'deleted_at',
		'at',
	];

	protected $touches = [
	];

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// CONFIGURATIONS
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// BOOT
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// CONSTRUCT
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// RELATIONSHIP
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	public function ref() {
		return $this->morphTo();
	}

	public function org() {
		return $this->belongsTo(\App\Org::class, 'org_id');
	}

	public function room_type() {
		return $this->belongsTo(\App\Models\Pricing\RoomType::class, 'room_type_id');
	}

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// BOOT
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// STATIC FUNCTION
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// FUNCTION
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	public function getRules()
	{
		$rules['org_id']            = ['required', 'integer', 'exists:'. app()->make(\App\Org::class)->getTable() . ',id'];
		$rules['room_type_id']      = ['required', 'integer', 'exists:'. app()->make(\App\Models\Pricing\RoomType::class)->getTable() . ',id'];
		$rules['at'] 				= ['required', 'date'];
		$rules['qty_reserved']		= ['required', 'integer', 'gte:0'];
		
		return $rules;
	}

	
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// ACCESSOR
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// MUTATOR
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// QUERY
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	public function scopeOrgId($q, Int $id){
		return $q->where('org_id', '=', $id);
	}

	public function scopeRoomTypeId($q, Array $ids){
		return $q->whereIn('room_type_id', $ids);
	}

	public function scopeAvailable($q, $start, $end){
		return $q->where('at', '>=', $start)->where('at', '<=', $end)->where(function($q)use($end){
            $q->wherenull('expired_at')->orwhere('expired_at', '<=', $end);
        });
	}
	
}
