<?php

namespace App;

use Illuminate\Database\Eloquent\Model;

class UserRole extends Model
{
    // --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// TRAITS
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// VARIABLES
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	protected $table = 'user_roles';

	protected $fillable = [
		'user_id',
		'org_id',
		'role',
		'scopes',
		'ended_at',
		'photo_url'
	];

	public $timestamps = true;

	protected $hidden = [
	];

	protected $casts = [
		'scopes'	=> 'array'
	];

	protected $dates = [
		'ended_at'
	];

	protected $touches = [
	];

	protected $observables = [
	];

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// CONFIGURATIONS
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	const ROLES 	= [
		'OWNER', 
		'CASHIER',
		'HRM',
		'ADMIN_HRD',
		'CHIEF_ACCOUNTING',

	];

	const SCOPES	= [
		'OWNER' 			=> ['*'], 
		'CASHIER'		 	=> ['POS.INVOICE', 'POS.SETTLEMENT'],
		'HRM'				=> ['ROLE'],
		'ADMIN_HRD'			=> [],
		'CHIEF_ACCOUNTING'	=> ['ACCOUNTING*', 'PARTNER.PAYABLE'],
	];
	
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// BOOT
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// CONSTRUCT
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// RELATIONSHIP
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	public function user() {
		return $this->belongsTo(User::class, 'user_id');
	}

	public function org() {
		return $this->belongsTo(Org::class, 'org_id');
	}

	public function absents($date = 'now') {
		$date  	= \Carbon\Carbon::parse($date);
		return $this->hasMany(\Thuderlabid\HR\Absent::class, 'org_id', 'org_id')->where('user_id', $this->user_id)->where('date', $date);
	}
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// BOOT
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// STATIC FUNCTION
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// FUNCTION
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	public function getRules()
	{
		$rules['user_id']    = ['required', 'exists:' . app()->make(User::class)->getTable() . ',id'];
		$rules['org_id']     = ['required', 'exists:' . app()->make(Org::class)->getTable() . ',id'];
		$rules['role']       = ['required', 'string', 'in:' . implode(',', Static::ROLES)];
		$rules['scopes']     = ['nullable', 'array'];
		$rules['ended_at']   = ['nullable', 'date'];
		$rules['photo_url']  = ['nullable', 'string'];

		return $rules;
	}
	
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// ACCESSOR
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// MUTATOR
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// QUERY
	// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	public function scopeRole($q, String $v)
	{
		return $q->where('role', 'like', str_replace('*', '%', $v));
	}
}
